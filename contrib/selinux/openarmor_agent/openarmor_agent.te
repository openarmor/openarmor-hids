policy_module(openarmor_agent, 1.0.4)
# selinux module for openarmor (tm) agent
# (C) Ivan Agarkov, 2017
# exec file types
type openarmor_agent_exec_t;
type openarmor_exec_exec_t;
type openarmor_logcollector_exec_t;
type openarmor_syscheck_exec_t;
type openarmor_admin_exec_t;
# data file types
type openarmor_log_t; # logs/
type openarmor_conf_t; # /etc
type openarmor_queue_t; # /queue
type openarmor_tmp_t; # /tmp
type openarmor_var_t; # /var
# process attributes
attribute openarmor_process;
# process types
type openarmor_agent_t, openarmor_process;
type openarmor_exec_t, openarmor_process;
type openarmor_logcollector_t, openarmor_process;
type openarmor_syscheck_t, openarmor_process;
type openarmor_admin_t;

# types definitions
init_daemon_domain(openarmor_agent_t, openarmor_agent_exec_t)
init_daemon_domain(openarmor_logcollector_t, openarmor_logcollector_exec_t)
init_daemon_domain(openarmor_syscheck_t, openarmor_syscheck_exec_t)
init_daemon_domain(openarmor_exec_t, openarmor_exec_exec_t)
application_domain(openarmor_admin_t, openarmor_admin_exec_t)

files_type(openarmor_queue_t)
files_type(openarmor_var_t)
logging_log_file(openarmor_log_t)
files_config_file(openarmor_conf_t)
files_tmp_file(openarmor_tmp_t)
# type transition for all
files_tmp_filetrans(openarmor_process, openarmor_tmp_t, {file dir lnk_file})
filetrans_pattern(openarmor_process, openarmor_queue_t, openarmor_queue_t, {file dir lnk_file sock_file})
filetrans_pattern(openarmor_process, openarmor_var_t, openarmor_var_t, {file dir lnk_file })
filetrans_pattern(openarmor_process, openarmor_conf_t, openarmor_conf_t, {file dir lnk_file })
filetrans_pattern(openarmor_process, openarmor_tmp_t, openarmor_tmp_t, {file dir lnk_file })
# allow openarmor agent to read & edit all
read_files_pattern(openarmor_process, openarmor_conf_t, openarmor_conf_t)
admin_pattern(openarmor_process, openarmor_queue_t, openarmor_queue_t)

admin_pattern(openarmor_process, openarmor_log_t, openarmor_log_t)
admin_pattern(openarmor_process, openarmor_var_t, openarmor_var_t)
optional_policy(`
  gen_require(`
    type passwd_file_t, etc_t;
  ')
  read_files_pattern(openarmor_process, etc_t, passwd_file_t)
')
allow openarmor_process openarmor_process:unix_dgram_socket all_unix_dgram_socket_perms;
sysnet_dns_name_resolve(openarmor_process)
allow openarmor_process self:capability { dac_override setgid setuid sys_chroot };
# for agent
admin_pattern(openarmor_agent_t, openarmor_conf_t, openarmor_conf_t)
admin_pattern(openarmor_agent_t, openarmor_tmp_t, openarmor_tmp_t)

# logcollector read all logs
logging_read_all_logs(openarmor_logcollector_t)
logging_read_audit_log(openarmor_logcollector_t)
# syscheck read all file
files_read_all_files(openarmor_syscheck_t)
allow openarmor_syscheck_t self:process setsched;
allow openarmor_syscheck_t self:capability sys_nice;
# admin policy
admin_pattern(openarmor_admin_t, openarmor_conf_t, openarmor_conf_t)
admin_pattern(openarmor_admin_t, openarmor_queue_t, openarmor_queue_t)
admin_pattern(openarmor_admin_t, openarmor_var_t, openarmor_var_t)
# allow to kill
allow openarmor_admin_t openarmor_process:process { signal sigkill ptrace sigstop getattr setrlimit noatsecure };
# for different roles
optional_policy(`
  gen_require(`
    type unconfined_t;
    role unconfined_r;
  ')
  role unconfined_r types openarmor_admin_t;
  domtrans_pattern(unconfined_t, openarmor_admin_exec_t, openarmor_admin_t)
')
optional_policy(`
  gen_require(`
    type sysadm_t;
    role sysadm_r;
  ')
  role sysadm_r types openarmor_admin_t;
  domtrans_pattern(sysadm_t, openarmor_admin_exec_t, openarmor_admin_t)
')
optional_policy(`
  gen_require(`
    type staff_t;
    role staff_r;
  ')
  role staff_r types openarmor_admin_t;
  domtrans_pattern(staff_t, openarmor_admin_exec_t, openarmor_admin_t)
')

